# Compare assemblies to reference genome and to each other using nucmer/mummerplot
rule all:
    input:
        # Assemblies vs reference
        flye_vs_ref_plot="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/flye_vs_ref/flye_vs_ref.png",
        lja_vs_ref_plot="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/lja_vs_ref/lja_vs_ref.png",
        hifiasm_vs_ref_plot="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/hifiasm_vs_ref/hifiasm_vs_ref.png",
        # Assemblies vs assemblies
        #flye_vs_hifiasm_plot="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/flye_vs_hifiasm/flye_vs_hifiasm.png",
        flye_vs_lja_plot="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/flye_vs_lja/flye_vs_lja.png"
        hifiasm_vs_lja_plot="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/hifiasm_vs_lja/hifiasm_vs_lja.png"


# ========================================
# PART 1: Assemblies vs Reference
# ========================================

# Align Flye assembly to reference genome
rule nucmer_flye_vs_ref:
    input:
        reference="/data/courses/assembly-annotation-course/references/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa",
        assembly="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/flye/assembly.fasta"
    output:
        delta="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/flye_vs_ref/flye_vs_ref.delta"
    params:
        outdir="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/flye_vs_ref",
        prefix="flye_vs_ref"
    resources:
        time="04:00:00",
        mem_mb=64000
    threads: 8
    container:
        "/containers/apptainer/mummer4_gnuplot.sif"
    shell:
        """
        mkdir -p {params.outdir}
        cd {params.outdir}
        
        # Run nucmer alignment
        nucmer \
            --prefix={params.prefix} \
            --breaklen=1000 \
            --mincluster=1000 \
            {input.reference} \
            {input.assembly}
        """


# Create dotplot visualization of Flye vs reference alignment
rule mummerplot_flye_vs_ref:
    input:
        delta="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/flye_vs_ref/flye_vs_ref.delta",
        reference="/data/courses/assembly-annotation-course/references/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa",
        assembly="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/flye/assembly.fasta"
    output:
        plot="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/flye_vs_ref/flye_vs_ref.png"
    params:
        outdir="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/flye_vs_ref",
        prefix="flye_vs_ref"
    resources:
        time="01:00:00",
        mem_mb=16000
    threads: 1
    container:
        "/containers/apptainer/mummer4_gnuplot.sif"
    shell:
        """
        cd {params.outdir}
        
        # Generate dotplot from alignment
        mummerplot \
            -R {input.reference} \
            -Q {input.assembly} \
            --filter \
            -t png \
            --large \
            --layout \
            --fat \
            --prefix={params.prefix} \
            {input.delta}
        """


# Align Hifiasm assembly to reference genome
rule nucmer_hifiasm_vs_ref:
    input:
        reference="/data/courses/assembly-annotation-course/references/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa",
        assembly="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/hifiasm/ERR11437344.asm.bp.p_ctg.fa"
    output:
        delta="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/hifiasm_vs_ref/hifiasm_vs_ref.delta"
    params:
        outdir="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/hifiasm_vs_ref",
        prefix="hifiasm_vs_ref"
    resources:
        time="04:00:00",
        mem_mb=64000
    threads: 8
    container:
        "/containers/apptainer/mummer4_gnuplot.sif"
    shell:
        """
        mkdir -p {params.outdir}
        cd {params.outdir}
        
        nucmer \
            --prefix={params.prefix} \
            --breaklen=1000 \
            --mincluster=1000 \
            {input.reference} \
            {input.assembly}
        """


# Create dotplot for Hifiasm vs reference
rule mummerplot_hifiasm_vs_ref:
    input:
        delta="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/hifiasm_vs_ref/hifiasm_vs_ref.delta",
        reference="/data/courses/assembly-annotation-course/references/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa",
        assembly="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/hifiasm/ERR11437344.asm.bp.p_ctg.fa"
    output:
        plot="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/hifiasm_vs_ref/hifiasm_vs_ref.png"
    params:
        outdir="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/hifiasm_vs_ref",
        prefix="hifiasm_vs_ref"
    resources:
        time="01:00:00",
        mem_mb=16000
    threads: 1
    container:
        "/containers/apptainer/mummer4_gnuplot.sif"
    shell:
        """
        cd {params.outdir}
        
        mummerplot \
            -R {input.reference} \
            -Q {input.assembly} \
            --filter \
            -t png \
            --large \
            --layout \
            --fat \
            --prefix={params.prefix} \
            {input.delta}
        """


# Align LJA assembly to reference genome
rule nucmer_lja_vs_ref:
    input:
        reference="/data/courses/assembly-annotation-course/references/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa",
        assembly="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/LJA/assembly.fasta"
    output:
        delta="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/lja_vs_ref/lja_vs_ref.delta"
    params:
        outdir="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/lja_vs_ref",
        prefix="lja_vs_ref"
    resources:
        time="04:00:00",
        mem_mb=64000
    threads: 8
    container:
        "/containers/apptainer/mummer4_gnuplot.sif"
    shell:
        """
        mkdir -p {params.outdir}
        cd {params.outdir}
        
        nucmer \
            --prefix={params.prefix} \
            --breaklen=1000 \
            --mincluster=1000 \
            {input.reference} \
            {input.assembly}
        """


# Create dotplot for LJA vs reference
rule mummerplot_lja_vs_ref:
    input:
        delta="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/lja_vs_ref/lja_vs_ref.delta",
        reference="/data/courses/assembly-annotation-course/references/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa",
        assembly="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/LJA/assembly.fasta"
    output:
        plot="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/lja_vs_ref/lja_vs_ref.png"
    params:
        outdir="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/lja_vs_ref",
        prefix="lja_vs_ref"
    resources:
        time="01:00:00",
        mem_mb=16000
    threads: 1
    container:
        "/containers/apptainer/mummer4_gnuplot.sif"
    shell:
        """
        cd {params.outdir}
        
        mummerplot \
            -R {input.reference} \
            -Q {input.assembly} \
            --filter \
            -t png \
            --large \
            --layout \
            --fat \
            --prefix={params.prefix} \
            {input.delta}
        """


# ========================================
# PART 2: Assemblies vs Assemblies
# ========================================

# Compare Flye and Hifiasm assemblies directly
rule nucmer_flye_vs_hifiasm:
    input:
        ref_assembly="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/flye/assembly.fasta",
        query_assembly="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/hifiasm/ERR11437344.asm.bp.p_ctg.fa"
    output:
        delta="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/flye_vs_hifiasm/flye_vs_hifiasm.delta"
    params:
        outdir="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/flye_vs_hifiasm",
        prefix="flye_vs_hifiasm"
    resources:
        time="04:00:00",
        mem_mb=64000
    threads: 8
    container:
        "/containers/apptainer/mummer4_gnuplot.sif"
    shell:
        """
        mkdir -p {params.outdir}
        cd {params.outdir}
        
        # Align two assemblies to see where they agree/differ
        nucmer \
            --prefix={params.prefix} \
            --breaklen=1000 \
            --mincluster=1000 \
            {input.ref_assembly} \
            {input.query_assembly}
        """


# Visualize Flye vs Hifiasm comparison
rule mummerplot_flye_vs_hifiasm:
    input:
        delta="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/flye_vs_hifiasm/flye_vs_hifiasm.delta",
        ref_assembly="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/flye/assembly.fasta",
        query_assembly="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/hifiasm/ERR11437344.asm.bp.p_ctg.fa"
    output:
        plot="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/flye_vs_hifiasm/flye_vs_hifiasm.png"
    params:
        outdir="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/flye_vs_hifiasm",
        prefix="flye_vs_hifiasm"
    resources:
        time="01:00:00",
        mem_mb=16000
    threads: 1
    container:
        "/containers/apptainer/mummer4_gnuplot.sif"
    shell:
        """
        cd {params.outdir}
        
        mummerplot \
            -R {input.ref_assembly} \
            -Q {input.query_assembly} \
            --filter \
            -t png \
            --large \
            --layout \
            --fat \
            --prefix={params.prefix} \
            {input.delta}
        """


rule nucmer_flye_vs_lja:
    input:
        ref_assembly="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/flye/assembly.fasta",
        query_assembly="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/LJA/assembly.fasta"
    output:
        delta="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/flye_vs_lja/flye_vs_lja.delta"
    params:
        outdir="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/flye_vs_lja",
        prefix="flye_vs_lja"
    resources:
        time="04:00:00",
        mem_mb=64000
    threads: 8
    container:
        "/containers/apptainer/mummer4_gnuplot.sif"
    shell:
        """
        mkdir -p {params.outdir}
        cd {params.outdir}
        
        nucmer \
            --prefix={params.prefix} \
            --breaklen=1000 \
            --mincluster=1000 \
            {input.ref_assembly} \
            {input.query_assembly}
        """


rule mummerplot_flye_vs_lja:
    input:
        delta="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/flye_vs_lja/flye_vs_lja.delta",
        ref_assembly="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/flye/assembly.fasta",
        query_assembly="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/LJA/assembly.fasta"
    output:
        plot="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/flye_vs_lja/flye_vs_lja.png"
    params:
        outdir="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/flye_vs_lja",
        prefix="flye_vs_lja"
    resources:
        time="01:00:00",
        mem_mb=16000
    threads: 1
    container:
        "/containers/apptainer/mummer4_gnuplot.sif"
    shell:
        """
        cd {params.outdir}
        
        mummerplot \
            -R {input.ref_assembly} \
            -Q {input.query_assembly} \
            --filter \
            -t png \
            --large \
            --layout \
            --fat \
            --prefix={params.prefix} \
            {input.delta}
        """


rule nucmer_hifiasm_vs_lja:
    input:
        ref_assembly="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/hifiasm/ERR11437344.asm.bp.p_ctg.fa",
        query_assembly="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/LJA/assembly.fasta"
    output:
        delta="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/hifiasm_vs_lja/hifiasm_vs_lja.delta"
    params:
        outdir="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/hifiasm_vs_lja",
        prefix="hifiasm_vs_lja"
    resources:
        time="04:00:00",
        mem_mb=64000
    threads: 8
    container:
        "/containers/apptainer/mummer4_gnuplot.sif"
    shell:
        """
        mkdir -p {params.outdir}
        cd {params.outdir}
        
        nucmer \
            --prefix={params.prefix} \
            --breaklen=1000 \
            --mincluster=1000 \
            {input.ref_assembly} \
            {input.query_assembly}
        """


rule mummerplot_hifiasm_vs_lja:
    input:
        delta="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/hifiasm_vs_lja/hifiasm_vs_lja.delta",
        ref_assembly="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/hifiasm/ERR11437344.asm.bp.p_ctg.fa",
        query_assembly="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/LJA/assembly.fasta"
    output:
        plot="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/hifiasm_vs_lja/hifiasm_vs_lja.png"
    params:
        outdir="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/nucmer/hifiasm_vs_lja",
        prefix="hifiasm_vs_lja"
    resources:
        time="01:00:00",
        mem_mb=16000
    threads: 1
    container:
        "/containers/apptainer/mummer4_gnuplot.sif"
    shell:
        """
        cd {params.outdir}
        
        mummerplot \
            -R {input.ref_assembly} \
            -Q {input.query_assembly} \
            --filter \
            -t png \
            --large \
            --layout \
            --fat \
            --prefix={params.prefix} \
            {input.delta}
        """