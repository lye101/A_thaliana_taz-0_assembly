# Run QUAST assembly evaluation both with and without reference genome
rule all:
    input:
        with_references="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/out_flags/quast/quast_with_refs.flag",
        without_references="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/out_flags/quast/quast_no_refs.flag"


# Compare assemblies against the reference genome
rule quast_with_references:
    input: 
        flye="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/flye/assembly.fasta",
        lja="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/LJA/assembly.fasta",
        dna="/data/courses/assembly-annotation-course/references/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa",
        gff3="/data/courses/assembly-annotation-course/references/Arabidopsis_thaliana.TAIR10.57.gff3"
        #trinity_done="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/out_flags/finished_trinity.flag",
    output:
        flag="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/out_flags/quast/quast_with_refs.flag"
    params:
        outdir="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/quast"
    resources:
        time="02:00:00",
        mem_mb=64000
    threads: 16
    container:
        "/containers/apptainer/quast_5.2.0.sif"
    shell:
        """
        mkdir -p {params.outdir}

        # Run QUAST with reference genome and annotations for more detailed metrics
        quast.py \
            -o "{params.outdir}/with_reference" \
            --eukaryote \
            --large \
            --est-ref-size 135000000 \ # a. thaliana genome size 
            --threads {threads} \
            --labels Flye,LJA \
            --no-sv \ # no structural variants is faster, but doesnt give strucutral variants
            -r {input.dna} \
            --features {input.gff3} \ # give genes and genomic features 
            {input.flye} {input.lja}

        touch {output.flag}
        """

# Evaluate assemblies without reference for unbiased comparison
rule quast_without_references:
    input: 
        flye="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/flye/assembly.fasta",
        lja="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/assemblies/LJA/assembly.fasta",
        #trinity_done="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/out_flags/finished_trinity.flag",
    output:
        flag="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/out_flags/quast/quast_no_refs.flag"
    params:
        outdir="/data/users/ltucker/A_thaliana_Taz-0_assembly/output/quast"
    resources:
        time="02:00:00",
        mem_mb=64000
    threads: 16
    container:
        "/containers/apptainer/quast_5.2.0.sif"
    shell:
        """
        mkdir -p {params.outdir}

        # Run QUAST without reference to get basic stats only
        quast.py \
            -o "{params.outdir}/no_reference" \
            --eukaryote \
            --large \
            --est-ref-size 135000000 \ # a. thaliana genome size 
            --threads {threads} \
            --labels Flye,LJA \
            --no-sv \
            {input.flye} {input.lja}

        touch {output.flag}
        """